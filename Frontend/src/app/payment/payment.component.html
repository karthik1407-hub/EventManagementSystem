<div class="checkout-container">
  <div class="payment-details">
    <header class="payment-header">
      <h1>Payment Details</h1>
      <p>Complete your purchase by providing your payment details.</p>
    </header>

    <div class="card-flipper-container">
      <div class="card-flipper" [class.flipped]="isCvvFocused">
        <div class="credit-card card-front">
          <div class="chip"></div>
          <div class="visa-logo">VISA</div>
          <div class="card-number">
            {{ getMaskedCardNumber() }}
          </div>
          <div class="card-details-row">
            <div class="card-holder">
              <label>Card Holder</label>
              <div>{{ cardHolder ? cardHolder.toUpperCase() : 'FULL NAME' }}</div>
            </div>
            <div class="card-expires">
              <label>Expires</label>
              <div>{{ expiryMonth && expiryYear ? expiryMonth + '/' + expiryYear.slice(2) : 'MM/YY' }}</div>
            </div>
          </div>
        </div>
        <div class="credit-card card-back">
          <div class="magnetic-stripe"></div>
          <div class="cvv-section">
            <label>CVV</label>
            <div class="cvv-display">{{ cvv }}</div>
          </div>
        </div>
      </div>
    </div>

    <form #paymentForm="ngForm" novalidate class="payment-form">
      <div class="input-group">
        <label for="cardNumber">Card Number</label>
        <div class="input-wrapper">
          <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
          <input type="text" id="cardNumber" name="cardNumber" [(ngModel)]="cardNumber" required minlength="16" maxlength="19" pattern="^\d{16,19}$" placeholder="1234 5678 9123 0000" #cardNumberField="ngModel" />
        </div>
        <div *ngIf="cardNumberField.invalid && (cardNumberField.dirty || cardNumberField.touched)" class="error-message">
          <div *ngIf="cardNumberField.errors?.['pattern'] || cardNumberField.errors?.['minlength']">Enter a valid card number.</div>
        </div>
      </div>

      <div class="input-group">
        <label for="cardHolder">Card Holder</label>
        <div class="input-wrapper">
          <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          <input type="text" id="cardHolder" name="cardHolder" [(ngModel)]="cardHolder" required placeholder="John Doe" #cardHolderField="ngModel" />
        </div>
        <div *ngIf="cardHolderField.invalid && (cardHolderField.dirty || cardHolderField.touched)" class="error-message">
          <div *ngIf="cardHolderField.errors?.['required']">Card holder name is required.</div>
        </div>
      </div>

      <div class="form-row">
        <div class="input-group">
          <label for="expiryMonth">Expiration Date</label>
          <div class="select-group">
            <select id="expiryMonth" name="expiryMonth" [(ngModel)]="expiryMonth" required #expiryMonthField="ngModel">
              <option value="" disabled selected>Month</option>
              <option *ngFor="let month of months" [value]="month">{{ month }}</option>
            </select>
            <select id="expiryYear" name="expiryYear" [(ngModel)]="expiryYear" required #expiryYearField="ngModel">
              <option value="" disabled selected>Year</option>
              <option *ngFor="let year of years" [value]="year">{{ year }}</option>
            </select>
          </div>
        </div>

        <div class="input-group">
          <label for="cvv">CVV</label>
          <div class="input-wrapper">
            <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
            <input type="password" id="cvv" name="cvv" [(ngModel)]="cvv" required minlength="3" maxlength="4" pattern="\d{3,4}" placeholder="123" #cvvField="ngModel" (focus)="onCvvFocus()" (blur)="onCvvBlur()" />
          </div>
        </div>
      </div>

      <button type="button" class="pay-button" (click)="processPayment(paymentForm)" [disabled]="paymentForm.invalid || isLoading">
        <span *ngIf="!isLoading">Pay ${{ getTotalAmount() }}</span>
        <span *ngIf="isLoading" class="spinner"></span>
      </button>
      <div *ngIf="paymentError" class="error-message payment-error">{{ paymentError }}</div>
    </form>
  </div>

  <div class="order-summary-panel" *ngIf="basket && basket.items && basket.items.length > 0">
    <h3>Order Summary</h3>
    <div class="order-items-list">
      <div *ngFor="let item of basket.items" class="order-item">
        <img [src]="'https://localhost:7272/EventImages/' + events[item.eventId].eventImageUrl" alt="{{ events[item.eventId].eventName }}" class="item-image" />
        <div class="item-details">
          <div class="item-name">{{ events[item.eventId].eventName || 'Unknown Event' }}</div>
          <div class="item-quantity">Qty: {{ item.quantity }}</div>
        </div>
        <div class="item-price">${{ item.unitPrice * item.quantity | number:'1.2-2' }}</div>
      </div>
    </div>



    <div class="summary-line">
      <span>Subtotal</span>
      <span>${{ getTotalAmount() | number:'1.2-2' }}</span>
    </div>

    <div class="summary-total">
      <span>Total</span>
      <span class="total-amount">${{ getTotalAmount() | number:'1.2-2' }}</span>
    </div>
  </div>
</div>